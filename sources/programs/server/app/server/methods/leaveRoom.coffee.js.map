{"version":3,"sources":["meteor://ðŸ’»app/server/methods/leaveRoom.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,aAAW,SAAC,GAAD;AACV;AAAA,eAAa,CAAC,MAAP,EAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,GAAb,EAAkB,qCAAlB,CAAV,CADD;KAAA;AAAA,IAGA,IAAI,CAAC,OAAL,EAHA;AAAA,IAKA,SAAS,MAAM,CAAC,MAAP,EALT;AAAA,IAMA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,GAApC,CANP;AAAA,IAOA,OAAO,MAAM,CAAC,IAAP,EAPP;AAUA,QAAG,UAAU,CAAC,KAAK,CAAC,OAAjB,CAAyB,IAAI,CAAC,GAA9B,EAAmC,OAAnC,EAA4C,IAAI,CAAC,GAAjD,CAAH;AACC,kBAAY,UAAU,CAAC,KAAK,CAAC,cAAjB,CAAgC,OAAhC,EAAyC,IAAI,CAAC,GAA9C,CAAkD,CAAC,KAAnD,EAA0D,CAAC,MAAvE;AACA,UAAG,cAAa,CAAhB;AACC,cAAU,UAAM,CAAC,KAAP,CAAa,YAAb,EAA2B,qEAA3B,CAAV,CADD;OAFD;KAVA;AAAA,IAeA,UAAU,CAAC,SAAS,CAAC,GAArB,CAAyB,iBAAzB,EAA4C,IAA5C,EAAkD,IAAlD,CAfA;AAAA,IAiBA,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,kBAAxB,CAA2C,GAA3C,EAAgD,IAAI,CAAC,QAArD,CAjBA;AAmBA,QAAG,IAAI,CAAC,SAAS,CAAC,OAAf,CAAuB,IAAI,CAAC,QAA5B,MAA2C,EAA9C;AACC,oBAAc,IAAd;AAAA,MACA,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,gCAA3B,CAA4D,GAA5D,EAAiE,WAAjE,CADA,CADD;KAnBA;AAuBA,QAAG,IAAI,CAAC,CAAL,KAAU,GAAb;AACC,gBAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,8BAA3B,CAA0D,QAA1D,EAAoE,GAApE,EAAyE,IAAzE,EADD;KAvBA;AAAA,IA0BA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,uBAAhC,CAAwD,GAAxD,EAA6D,MAAM,CAAC,MAAP,EAA7D,CA1BA;WA4BA,MAAM,CAAC,KAAP,CAAa;aAEZ,UAAU,CAAC,SAAS,CAAC,GAArB,CAAyB,gBAAzB,EAA2C,IAA3C,EAAiD,IAAjD,EAFY;IAAA,CAAb,EA7BU;EAAA,CAAX;CADD","file":"/server/methods/leaveRoom.coffee.js","sourcesContent":["Meteor.methods\n\tleaveRoom: (rid) ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error(403, \"[methods] leaveRoom -> Invalid user\")\n\n\t\tthis.unblock()\n\n\t\tfromId = Meteor.userId()\n\t\troom = RocketChat.models.Rooms.findOneById rid\n\t\tuser = Meteor.user()\n\n\t\t# If user is room owner, check if there are other owners. If there isn't anyone else, warn user to set a new owner.\n\t\tif RocketChat.authz.hasRole(user._id, 'owner', room._id)\n\t\t\tnumOwners = RocketChat.authz.getUsersInRole('owner', room._id).fetch().length\n\t\t\tif numOwners is 1\n\t\t\t\tthrow new Meteor.Error 'last-owner', 'You_are_the_last_owner_Please_set_new_owner_before_leaving_the_room'\n\n\t\tRocketChat.callbacks.run 'beforeLeaveRoom', user, room\n\n\t\tRocketChat.models.Rooms.removeUsernameById rid, user.username\n\n\t\tif room.usernames.indexOf(user.username) isnt -1\n\t\t\tremovedUser = user\n\t\t\tRocketChat.models.Messages.createUserLeaveWithRoomIdAndUser rid, removedUser\n\n\t\tif room.t is 'l'\n\t\t\tRocketChat.models.Messages.createCommandWithRoomIdAndUser 'survey', rid, user\n\n\t\tRocketChat.models.Subscriptions.removeByRoomIdAndUserId rid, Meteor.userId()\n\n\t\tMeteor.defer ->\n\n\t\t\tRocketChat.callbacks.run 'afterLeaveRoom', user, room\n"]}