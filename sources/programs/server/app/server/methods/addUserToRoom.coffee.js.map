{"version":3,"sources":["meteor://ðŸ’»app/server/methods/addUserToRoom.coffee"],"names":[],"mappings":";;;;;;;;;AAAA,MAAM,CAAC,OAAP,CACC;AAAA,iBAAe,SAAC,IAAD;AACd;AAAA,aAAS,MAAM,CAAC,MAAP,EAAT;AACA,cAAY,CAAC,IAAN,gBAAW,IAAI,CAAE,YAAjB,EAAsB,MAAtB,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,oBAAb,EAAmC,cAAnC,EAAmD;AAAA,QAAE,QAAQ,aAAV;OAAnD,CAAV,CADD;KADA;AAIA,cAAY,CAAC,IAAN,gBAAW,IAAI,CAAE,iBAAjB,EAA2B,MAA3B,CAAP;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,wBAAb,EAAuC,kBAAvC,EAA2D;AAAA,QAAE,QAAQ,aAAV;OAA3D,CAAV,CADD;KAJA;AAAA,IAOA,OAAO,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,IAAI,CAAC,GAAzC,CAPP;AAUA,QAAG,IAAI,CAAC,CAAL,KAAU,GAAV,IAAkB,WAAc,CAAC,KAAK,CAAC,aAAjB,CAA+B,MAA/B,EAAuC,kBAAvC,EAA2D,IAAI,CAAC,GAAhE,CAAzB;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mBAAb,EAAkC,aAAlC,EAAiD;AAAA,QAAE,QAAQ,aAAV;OAAjD,CAAV,CADD;KAVA;AAaA,QAAG,IAAI,CAAC,CAAL,KAAU,GAAb;AACC,YAAU,UAAM,CAAC,KAAP,CAAa,mCAAb,EAAkD,oCAAlD,EAAwF;AAAA,QAAE,QAAQ,aAAV;OAAxF,CAAV,CADD;KAbA;AAiBA,QAAG,IAAI,CAAC,SAAS,CAAC,OAAf,CAAuB,IAAI,CAAC,QAA5B,MAA2C,EAA9C;AACC,aADD;KAjBA;AAAA,IAoBA,UAAU,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAxB,CAA0C,IAAI,CAAC,QAA/C,CApBV;AAAA,IAsBA,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,eAAxB,CAAwC,IAAI,CAAC,GAA7C,EAAkD,IAAI,CAAC,QAAvD,CAtBA;AAAA,IAwBA,MAAU,UAxBV;AAAA,IA0BA,UAAU,CAAC,MAAM,CAAC,aAAa,CAAC,qBAAhC,CAAsD,IAAtD,EAA4D,OAA5D,EACC;AAAA,UAAI,GAAJ;AAAA,MACA,MAAM,IADN;AAAA,MAEA,OAAO,IAFP;AAAA,MAGA,QAAQ,CAHR;KADD,CA1BA;AAAA,IAgCA,WAAW,UAAU,CAAC,MAAM,CAAC,KAAK,CAAC,WAAxB,CAAoC,MAApC,CAhCX;AAAA,IAiCA,UAAU,CAAC,MAAM,CAAC,QAAQ,CAAC,gCAA3B,CAA4D,IAAI,CAAC,GAAjE,EAAsE,OAAtE,EACC;AAAA,UAAI,GAAJ;AAAA,MACA,GACC;AAAA,aAAK,QAAQ,CAAC,GAAd;AAAA,QACA,UAAU,QAAQ,CAAC,QADnB;OAFD;KADD,CAjCA;AAuCA,WAAO,IAAP,CAxCc;EAAA,CAAf;CADD","file":"/server/methods/addUserToRoom.coffee.js","sourcesContent":["Meteor.methods\n\taddUserToRoom: (data) ->\n\t\tfromId = Meteor.userId()\n\t\tunless Match.test data?.rid, String\n\t\t\tthrow new Meteor.Error 'error-invalid-room', 'Invalid room', { method: addUserToRoom }\n\n\t\tunless Match.test data?.username, String\n\t\t\tthrow new Meteor.Error 'error-invalid-username', 'Invalid username', { method: addUserToRoom }\n\n\t\troom = RocketChat.models.Rooms.findOneById data.rid\n\n\t\t# if room.username isnt Meteor.user().username and room.t is 'c'\n\t\tif room.t is 'c' and not RocketChat.authz.hasPermission(fromId, 'add-user-to-room', room._id)\n\t\t\tthrow new Meteor.Error 'error-not-allowed', 'Not allowed', { method: addUserToRoom }\n\n\t\tif room.t is 'd'\n\t\t\tthrow new Meteor.Error 'error-cant-invite-for-direct-room', 'Can\\'t invite user to direct rooms', { method: addUserToRoom }\n\n\t\t# verify if user is already in room\n\t\tif room.usernames.indexOf(data.username) isnt -1\n\t\t\treturn\n\n\t\tnewUser = RocketChat.models.Users.findOneByUsername data.username\n\n\t\tRocketChat.models.Rooms.addUsernameById data.rid, data.username\n\n\t\tnow = new Date()\n\n\t\tRocketChat.models.Subscriptions.createWithRoomAndUser room, newUser,\n\t\t\tts: now\n\t\t\topen: true\n\t\t\talert: true\n\t\t\tunread: 1\n\n\t\tfromUser = RocketChat.models.Users.findOneById fromId\n\t\tRocketChat.models.Messages.createUserAddedWithRoomIdAndUser data.rid, newUser,\n\t\t\tts: now\n\t\t\tu:\n\t\t\t\t_id: fromUser._id\n\t\t\t\tusername: fromUser.username\n\n\t\treturn true\n"]}