{"version":3,"sources":["meteor://ðŸ’»app/lib/fileUpload.coffee"],"names":[],"mappings":"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","file":"/lib/fileUpload.coffee.js","sourcesContent":["if UploadFS?\n\tRocketChat.models.Uploads.model.allow\n\t\tinsert: (userId, doc) ->\n\t\t\treturn userId\n\n\t\tupdate: (userId, doc) ->\n\t\t\treturn userId is doc.userId\n\n\t\tremove: (userId, doc) ->\n\t\t\treturn userId is doc.userId\n\n\tinitFileStore = ->\n\t\tcookie = new Cookies()\n\t\tif Meteor.isClient\n\t\t\tcookie.set 'rc_uid', Meteor.userId();\n\t\t\tcookie.set 'rc_token', Meteor._localStorage.getItem('Meteor.loginToken')\n\t\t\tcookie.send()\n\n\t\tMeteor.fileStore = new UploadFS.store.GridFS\n\t\t\tcollection: RocketChat.models.Uploads.model\n\t\t\tname: 'rocketchat_uploads'\n\t\t\tcollectionName: 'rocketchat_uploads'\n\t\t\tfilter: new UploadFS.Filter\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\ttransformWrite: (readStream, writeStream, fileId, file) ->\n\t\t\t\tif RocketChatFile.enabled is false or not /^image\\/.+/.test(file.type)\n\t\t\t\t\treturn readStream.pipe writeStream\n\n\t\t\t\tstream = undefined\n\n\t\t\t\tidentify = (err, data) ->\n\t\t\t\t\tif err?\n\t\t\t\t\t\treturn stream.pipe writeStream\n\n\t\t\t\t\tfile.identify =\n\t\t\t\t\t\tformat: data.format\n\t\t\t\t\t\tsize: data.size\n\n\t\t\t\t\tif data.Orientation? and data.Orientation not in ['', 'Unknown', 'Undefined']\n\t\t\t\t\t\tRocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream)\n\t\t\t\t\telse\n\t\t\t\t\t\tstream.pipe writeStream\n\n\t\t\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream()\n\n\t\t\tonRead: (fileId, file, req, res) ->\n\t\t\t\tif RocketChat.settings.get 'FileUpload_ProtectFiles'\n\t\t\t\t\trawCookies = req.headers.cookie if req?.headers?.cookie?\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies) if rawCookies?\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies) if rawCookies?\n\n\t\t\t\t\tif not uid?\n\t\t\t\t\t\tuid = req.query.rc_uid\n\t\t\t\t\t\ttoken = req.query.rc_token\n\n\t\t\t\t\tunless uid and token and RocketChat.models.Users.findOneByIdAndLoginToken(uid, token)\n\t\t\t\t\t\tres.writeHead 403\n\t\t\t\t\t\treturn false\n\n\t\t\t\tres.setHeader 'content-disposition', \"attachment; filename=\\\"#{ encodeURIComponent(file.name) }\\\"\"\n\t\t\t\treturn true\n\n\tMeteor.startup ->\n\t\tif Meteor.isServer\n\t\t\tinitFileStore()\n\t\telse\n\t\t\tTracker.autorun (c) ->\n\t\t\t\tif Meteor.userId() and RocketChat.settings.subscription.ready()\n\t\t\t\t\tinitFileStore()\n\t\t\t\t\tc.stop()\n"]}