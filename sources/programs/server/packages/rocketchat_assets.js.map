{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_assets/server/assets.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_assets.js","sourcesContent":["sizeOf = Npm.require 'image-size'\nmime = Npm.require 'mime-types'\ncrypto = Npm.require 'crypto'\n\nmime.extensions['image/vnd.microsoft.icon'] = ['ico']\n\n@RocketChatAssetsInstance = new RocketChatFile.GridFS\n\tname: 'assets'\n\n\nassets =\n\t'logo':\n\t\tlabel: 'logo (svg, png, jpg)'\n\t\tdefaultUrl: 'images/logo/logo.svg'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['svg', 'png', 'jpg', 'jpeg']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon_ico':\n\t\tlabel: 'favicon.ico'\n\t\tdefaultUrl: 'favicon.ico'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['ico']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon':\n\t\tlabel: 'favicon.svg'\n\t\tdefaultUrl: 'images/logo/icon.svg'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['svg']\n\t\t\twidth: undefined\n\t\t\theight: undefined\n\t'favicon_64':\n\t\tlabel: 'favicon.png (64x64)'\n\t\tdefaultUrl: 'images/logo/favicon-64x64.png'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 64\n\t\t\theight: 64\n\t'favicon_96':\n\t\tlabel: 'favicon.png (96x96)'\n\t\tdefaultUrl: 'images/logo/favicon-96x96.png'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 96\n\t\t\theight: 96\n\t'favicon_128':\n\t\tlabel: 'favicon.png (128x128)'\n\t\tdefaultUrl: 'images/logo/favicon-128x128.png'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 128\n\t\t\theight: 128\n\t'favicon_192':\n\t\tlabel: 'favicon.png (192x192)'\n\t\tdefaultUrl: 'images/logo/android-chrome-192x192.png'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 192\n\t\t\theight: 192\n\t'favicon_256':\n\t\tlabel: 'favicon.png (256x256)'\n\t\tdefaultUrl: 'images/logo/favicon-256x256.png'\n\t\tconstraints:\n\t\t\ttype: 'image'\n\t\t\textensions: ['png']\n\t\t\twidth: 256\n\t\t\theight: 256\n\n\nRocketChat.Assets = new class\n\tmime: mime\n\tassets: assets\n\n\tsetAsset: (binaryContent, contentType, asset) ->\n\t\tif not assets[asset]?\n\t\t\tthrow new Meteor.Error \"Invalid_asset\"\n\n\t\textension = mime.extension(contentType)\n\t\tif extension not in assets[asset].constraints.extensions\n\t\t\tthrow new Meteor.Error \"Invalid_file_type\", contentType\n\n\t\tfile = new Buffer(binaryContent, 'binary')\n\t\tif assets[asset].constraints.width? or assets[asset].constraints.height?\n\t\t\tdimensions = sizeOf file\n\n\t\t\tif assets[asset].constraints.width? and assets[asset].constraints.width isnt dimensions.width\n\t\t\t\tthrow new Meteor.Error \"Invalid_file_width\"\n\n\t\t\tif assets[asset].constraints.height? and assets[asset].constraints.height isnt dimensions.height\n\t\t\t\tthrow new Meteor.Error \"Invalid_file_height\"\n\n\t\trs = RocketChatFile.bufferToStream file\n\t\tRocketChatAssetsInstance.deleteFile asset\n\t\tws = RocketChatAssetsInstance.createWriteStream asset, contentType\n\t\tws.on 'end', Meteor.bindEnvironment ->\n\t\t\tMeteor.setTimeout ->\n\t\t\t\tRocketChat.settings.updateById \"Assets_#{asset}\", {\n\t\t\t\t\turl: \"/assets/#{asset}.#{extension}\"\n\t\t\t\t\tdefaultUrl: assets[asset].defaultUrl\n\t\t\t\t}\n\t\t\t, 200\n\n\t\trs.pipe ws\n\t\treturn\n\n\tunsetAsset: (asset) ->\n\t\tif not assets[asset]?\n\t\t\tthrow new Meteor.Error \"Invalid_asset\"\n\n\t\tRocketChatAssetsInstance.deleteFile asset\n\n\t\tRocketChat.settings.updateById \"Assets_#{asset}\", {defaultUrl: assets[asset].defaultUrl}\n\t\treturn\n\n\trefreshClients: ->\n\t\tprocess.emit('message', {refresh: 'client'})\n\n\nRocketChat.settings.addGroup 'Assets'\nfor key, value of assets\n\tdo (key, value) ->\n\t\tRocketChat.settings.add \"Assets_#{key}\", {defaultUrl: value.defaultUrl}, { type: 'asset', group: 'Assets', fileConstraints: value.constraints, i18nLabel: value.label, asset: key, public: true }\n\nMeteor.startup ->\n\tforEachAsset = (key, value) ->\n\t\tRocketChat.settings.get \"Assets_#{key}\", (settingKey, settingValue) ->\n\t\t\tif not settingValue?.url?\n\t\t\t\tvalue.cache = undefined\n\t\t\t\treturn\n\n\t\t\tfile = RocketChatAssetsInstance.getFileWithReadStream key\n\t\t\tif not file\n\t\t\t\tvalue.cache = undefined\n\t\t\t\treturn\n\n\t\t\tdata = []\n\t\t\tfile.readStream.on 'data', Meteor.bindEnvironment (chunk) ->\n\t\t\t\tdata.push chunk\n\n\t\t\tfile.readStream.on 'end', Meteor.bindEnvironment ->\n\t\t\t\tdata = Buffer.concat(data)\n\t\t\t\thash = crypto.createHash('sha1').update(data).digest('hex')\n\t\t\t\textension = settingValue.url.split('.').pop()\n\t\t\t\tvalue.cache =\n\t\t\t\t\tpath: \"assets/#{key}.#{extension}\"\n\t\t\t\t\tcacheable: false\n\t\t\t\t\tsourceMapUrl: undefined\n\t\t\t\t\twhere: 'client'\n\t\t\t\t\ttype: 'asset'\n\t\t\t\t\tcontent: data\n\t\t\t\t\textension: extension\n\t\t\t\t\turl: \"/assets/#{key}.#{extension}?#{hash}\"\n\t\t\t\t\tsize: file.length\n\t\t\t\t\tuploadDate: file.uploadDate\n\t\t\t\t\tcontentType: file.contentType\n\t\t\t\t\thash: hash\n\n\n\tforEachAsset(key, value) for key, value of assets\n\ncalculateClientHash = WebAppHashing.calculateClientHash\nWebAppHashing.calculateClientHash = (manifest, includeFilter, runtimeConfigOverride) ->\n\tfor key, value of assets\n\t\tif not value.cache? && not value.defaultUrl?\n\t\t\tcontinue\n\n\t\tmanifestItem = _.find manifest, (item) ->\n\t\t\treturn item.path is key\n\n\t\tcache = {}\n\t\tif value.cache\n\t\t\tcache =\n\t\t\t\tpath: value.cache.path\n\t\t\t\tcacheable: value.cache.cacheable\n\t\t\t\tsourceMapUrl: value.cache.sourceMapUrl\n\t\t\t\twhere: value.cache.where\n\t\t\t\ttype: value.cache.type\n\t\t\t\turl: value.cache.url\n\t\t\t\tsize: value.cache.size\n\t\t\t\thash: value.cache.hash\n\n\t\t\tWebAppInternals.staticFiles[\"/__cordova/assets/#{key}\"] = value.cache\n\t\t\tWebAppInternals.staticFiles[\"/__cordova/assets/#{key}.#{value.cache.extension}\"] = value.cache\n\t\telse\n\t\t\textension = value.defaultUrl.split('.').pop()\n\t\t\tcache =\n\t\t\t\tpath: \"assets/#{key}.#{extension}\"\n\t\t\t\tcacheable: false\n\t\t\t\tsourceMapUrl: undefined\n\t\t\t\twhere: 'client'\n\t\t\t\ttype: 'asset'\n\t\t\t\turl: \"/assets/#{key}.#{extension}?v3\"\n\t\t\t\t# size: value.cache.size\n\t\t\t\thash: 'v3'\n\n\t\t\tWebAppInternals.staticFiles[\"/__cordova/assets/#{key}\"] = WebAppInternals.staticFiles[\"/__cordova/#{value.defaultUrl}\"]\n\t\t\tWebAppInternals.staticFiles[\"/__cordova/assets/#{key}.#{extension}\"] = WebAppInternals.staticFiles[\"/__cordova/#{value.defaultUrl}\"]\n\n\n\t\tif manifestItem?\n\t\t\tindex = manifest.indexOf(manifestItem)\n\n\t\t\tmanifest[index] = cache\n\t\telse\n\t\t\tmanifest.push cache\n\n\treturn calculateClientHash.call this, manifest, includeFilter, runtimeConfigOverride\n\n\nMeteor.methods\n\trefreshClients: ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error 'invalid-user', \"[methods] unsetAsset -> Invalid user\"\n\n\t\thasPermission = RocketChat.authz.hasPermission Meteor.userId(), 'manage-assets'\n\t\tunless hasPermission\n\t\t\tthrow new Meteor.Error 'manage-assets-not-allowed', \"[methods] unsetAsset -> Manage assets not allowed\"\n\n\t\tRocketChat.Assets.refreshClients\n\n\n\tunsetAsset: (asset) ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error 'invalid-user', \"[methods] unsetAsset -> Invalid user\"\n\n\t\thasPermission = RocketChat.authz.hasPermission Meteor.userId(), 'manage-assets'\n\t\tunless hasPermission\n\t\t\tthrow new Meteor.Error 'manage-assets-not-allowed', \"[methods] unsetAsset -> Manage assets not allowed\"\n\n\t\tRocketChat.Assets.unsetAsset asset\n\n\n\tsetAsset: (binaryContent, contentType, asset) ->\n\t\tunless Meteor.userId()\n\t\t\tthrow new Meteor.Error 'invalid-user', \"[methods] setAsset -> Invalid user\"\n\n\t\thasPermission = RocketChat.authz.hasPermission Meteor.userId(), 'manage-assets'\n\t\tunless hasPermission\n\t\t\tthrow new Meteor.Error 'manage-assets-not-allowed', \"[methods] unsetAsset -> Manage assets not allowed\"\n\n\t\tRocketChat.Assets.setAsset binaryContent, contentType, asset\n\t\treturn\n\n\nWebApp.connectHandlers.use '/assets/', Meteor.bindEnvironment (req, res, next) ->\n\tparams =\n\t\tasset: decodeURIComponent(req.url.replace(/^\\//, '').replace(/\\?.*$/, '')).replace(/\\.[^.]*$/, '')\n\n\tfile = assets[params.asset]?.cache\n\n\tif not file?\n\t\tif assets[params.asset]?.defaultUrl?\n\t\t\treq.url = '/'+assets[params.asset].defaultUrl\n\t\t\tWebAppInternals.staticFilesMiddleware WebAppInternals.staticFiles, req, res, next\n\t\telse\n\t\t\tres.writeHead 404\n\t\t\tres.end()\n\n\t\treturn\n\n\treqModifiedHeader = req.headers[\"if-modified-since\"];\n\tif reqModifiedHeader?\n\t\tif reqModifiedHeader == file.uploadDate?.toUTCString()\n\t\t\tres.setHeader 'Last-Modified', reqModifiedHeader\n\t\t\tres.writeHead 304\n\t\t\tres.end()\n\t\t\treturn\n\n\tres.setHeader 'Cache-Control', 'public, max-age=0'\n\tres.setHeader 'Expires', '-1'\n\tres.setHeader 'Last-Modified', file.uploadDate?.toUTCString() or new Date().toUTCString()\n\tres.setHeader 'Content-Type', file.contentType\n\tres.setHeader 'Content-Length', file.size\n\n\tres.writeHead 200\n\tres.end(file.content)\n\treturn\n"]}