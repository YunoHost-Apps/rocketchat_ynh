{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_oauth2-server/model.coffee","meteor://ðŸ’»app/packages/rocketchat_oauth2-server/oauth.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_oauth2-server.js","sourcesContent":["AccessTokens = undefined\nRefreshTokens = undefined\nClients = undefined\nAuthCodes = undefined\ndebug = undefined\n\n@Model = class Model\n\tconstructor: (config={}) ->\n\t\tconfig.accessTokensCollectionName ?= 'oauth_access_tokens'\n\t\tconfig.refreshTokensCollectionName ?= 'oauth_refresh_tokens'\n\t\tconfig.clientsCollectionName ?= 'oauth_clients'\n\t\tconfig.authCodesCollectionName ?= 'oauth_auth_codes'\n\n\t\t@debug = debug = config.debug\n\n\t\t@AccessTokens = AccessTokens = config.accessTokensCollection or new Meteor.Collection config.accessTokensCollectionName\n\t\t@RefreshTokens = RefreshTokens = config.refreshTokensCollection or new Meteor.Collection config.refreshTokensCollectionName\n\t\t@Clients = Clients = config.clientsCollection or new Meteor.Collection config.clientsCollectionName\n\t\t@AuthCodes = AuthCodes = config.authCodesCollection or new Meteor.Collection config.authCodesCollectionName\n\n\n\tgetAccessToken: Meteor.bindEnvironment (bearerToken, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in getAccessToken (bearerToken:', bearerToken, ')'\n\n\t\ttry\n\t\t\ttoken = AccessTokens.findOne accessToken: bearerToken\n\t\t\tcallback null, token\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tgetClient: Meteor.bindEnvironment (clientId, clientSecret, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in getClient (clientId:', clientId, ', clientSecret:', clientSecret, ')'\n\n\t\ttry\n\t\t\tif not clientSecret?\n\t\t\t\tclient = Clients.findOne { active: true, clientId: clientId }\n\t\t\telse\n\t\t\t\tclient = Clients.findOne { active: true, clientId: clientId, clientSecret: clientSecret }\n\t\t\tcallback null, client\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tgrantTypeAllowed: (clientId, grantType, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in grantTypeAllowed (clientId:', clientId, ', grantType:', grantType + ')'\n\n\t\treturn callback(false, grantType in ['authorization_code'])\n\n\n\tsaveAccessToken: Meteor.bindEnvironment (token, clientId, expires, user, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in saveAccessToken (token:', token, ', clientId:', clientId, ', user:', user, ', expires:', expires, ')'\n\n\t\ttry\n\t\t\ttokenId = AccessTokens.insert\n\t\t\t\taccessToken: token\n\t\t\t\tclientId: clientId\n\t\t\t\tuserId: user.id\n\t\t\t\texpires: expires\n\n\t\t\tcallback null, tokenId\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tgetAuthCode: Meteor.bindEnvironment (authCode, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in getAuthCode (authCode: ' + authCode + ')'\n\n\t\ttry\n\t\t\tcode = AuthCodes.findOne authCode: authCode\n\t\t\tcallback null, code\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tsaveAuthCode: Meteor.bindEnvironment (code, clientId, expires, user, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in saveAuthCode (code:', code, ', clientId:', clientId, ', expires:', expires, ', user:', user, ')'\n\n\t\ttry\n\t\t\tcodeId = AuthCodes.upsert\n\t\t\t\tauthCode: code\n\t\t\t,\n\t\t\t\tauthCode: code\n\t\t\t\tclientId: clientId\n\t\t\t\tuserId: user.id\n\t\t\t\texpires: expires\n\n\t\t\tcallback null, codeId\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tsaveRefreshToken: Meteor.bindEnvironment (token, clientId, expires, user, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in saveRefreshToken (token:', token, ', clientId:', clientId, ', user:', user, ', expires:', expires, ')'\n\n\t\ttry\n\t\t\ttokenId = RefreshTokens.insert\n\t\t\t\trefreshToken: token\n\t\t\t\tclientId: clientId\n\t\t\t\tuserId: user.id\n\t\t\t\texpires: expires\n\n\t\t\t\tcallback null, tokenId\n\t\tcatch e\n\t\t\tcallback e\n\n\n\tgetRefreshToken: Meteor.bindEnvironment (refreshToken, callback) ->\n\t\tif debug is true\n\t\t\tconsole.log '[OAuth2Server]', 'in getRefreshToken (refreshToken: ' + refreshToken + ')'\n\n\t\ttry\n\t\t\ttoken = RefreshTokens.findOne refreshToken: refreshToken\n\t\t\tcallback null, token\n\t\tcatch e\n\t\t\tcallback e\n","oauthserver = Npm.require('oauth2-server')\nexpress = Npm.require('express')\n\n# WebApp.rawConnectHandlers.use app\n# JsonRoutes.Middleware.use app\n\n\nclass OAuth2Server\n\tconstructor: (@config={}) ->\n\t\t@app = express()\n\n\t\t@routes = express()\n\n\t\t@model = new Model(@config)\n\n\t\t@oauth = oauthserver\n\t\t\tmodel: @model\n\t\t\tgrants: ['authorization_code', 'refresh_token']\n\t\t\tdebug: @config.debug\n\n\t\t@publishAuhorizedClients()\n\t\t@initRoutes()\n\n\t\treturn @\n\n\n\tpublishAuhorizedClients: ->\n\t\tMeteor.publish 'authorizedOAuth', ->\n\t\t\t\tif not @userId?\n\t\t\t\t\treturn @ready()\n\n\t\t\t\treturn Meteor.users.find\n\t\t\t\t\t_id: @userId\n\t\t\t\t,\n\t\t\t\t\tfields:\n\t\t\t\t\t\t'oauth.athorizedClients': 1\n\n\t\t\t\treturn user?\n\n\n\tinitRoutes: ->\n\t\tself = @\n\t\tdebugMiddleware = (req, res, next) ->\n\t\t\tif self.config.debug is true\n\t\t\t\tconsole.log '[OAuth2Server]', req.method, req.url\n\t\t\tnext()\n\n\t\t@app.all '/oauth/token', debugMiddleware, @oauth.grant()\n\n\t\t@app.get '/oauth/authorize', debugMiddleware, Meteor.bindEnvironment (req, res, next) ->\n\t\t\tclient = self.model.Clients.findOne({ active: true, clientId: req.query.client_id })\n\t\t\tif not client?\n\t\t\t\treturn res.redirect '/oauth/error/404'\n\n\t\t\tif client.redirectUri isnt req.query.redirect_uri\n\t\t\t\treturn res.redirect '/oauth/error/invalid_redirect_uri'\n\n\t\t\tnext()\n\n\t\t@app.post '/oauth/authorize', debugMiddleware, Meteor.bindEnvironment (req, res, next) ->\n\t\t\tif not req.body.token?\n\t\t\t\treturn res.sendStatus(401).send('No token')\n\n\t\t\tuser = Meteor.users.findOne\n\t\t\t\t'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken req.body.token\n\n\t\t\tif not user?\n\t\t\t\treturn res.sendStatus(401).send('Invalid token')\n\n\t\t\treq.user =\n\t\t\t\tid: user._id\n\n\t\t\tnext()\n\n\n\t\t@app.post '/oauth/authorize', debugMiddleware, @oauth.authCodeGrant (req, next) ->\n\t\t\tif req.body.allow is 'yes'\n\t\t\t\tMeteor.users.update req.user.id, {$addToSet: {'oauth.athorizedClients': @clientId}}\n\n\t\t\tnext(null, req.body.allow is 'yes', req.user)\n\n\t\t@app.use @routes\n\n\t\t@app.all '/oauth/*', @oauth.errorHandler()\n"]}