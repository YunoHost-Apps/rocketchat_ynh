{"version":3,"sources":["meteor://ðŸ’»app/globalFileRestrictions.js","meteor://ðŸ’»app/lib/FileUpload.js","meteor://ðŸ’»app/lib/FileUploadBase.js","meteor://ðŸ’»app/server/lib/FileUpload.js","meteor://ðŸ’»app/server/lib/requests.js","meteor://ðŸ’»app/server/config/configFileUploadAmazonS3.js","meteor://ðŸ’»app/server/config/configFileUploadFileSystem.js","meteor://ðŸ’»app/server/config/configFileUploadGridFS.js","meteor://ðŸ’»app/server/methods/sendFileMessage.js","meteor://ðŸ’»app/server/startup/settings.js"],"names":[],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nSlingshot.fileRestrictions('rocketchat-uploads', {\n\tauthorize: function(file/*, metaContext*/) {\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('Invalid_file_type'));\n\t\t}\n\n\t\tvar maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: maxFileSize }));\n\t\t}\n\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-require', 'Please login before posting files');\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n});\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nvar maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (file.size > maxFileSize) {\n\t\t\tthrow new Meteor.Error('file-too-large', 'File is too large');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error('invalid-file-type', 'File type is not accepted');\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});\n","/* globals FileUploadBase:true */\n/* exported FileUploadBase */\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(meta, file/*, data*/) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart() {\n\n\t}\n\n\tstop() {\n\n\t}\n};\n","/* globals FileUpload:true */\nFileUpload.handlers = {};\n\nFileUpload.addHandler = function(store, handler) {\n\tthis.handlers[store] = handler;\n};\n\nFileUpload.delete = function(fileId) {\n\tlet file = RocketChat.models.Uploads.findOneById(fileId);\n\n\tif (!file) {\n\t\treturn;\n\t}\n\n\tthis.handlers[file.store].delete(file);\n\n\treturn RocketChat.models.Uploads.remove(file._id);\n};\n\nFileUpload.get = function(file, req, res, next) {\n\tif (file.store && this.handlers && this.handlers[file.store] && this.handlers[file.store].get) {\n\t\tthis.handlers[file.store].get.call(this, file, req, res, next);\n\t} else {\n\t\tres.writeHead(404);\n\t\tres.end();\n\t\treturn;\n\t}\n};\n","/* globals FileUpload, WebApp, Cookies */\nvar protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nWebApp.connectHandlers.use('/file-upload/', function(req, res, next) {\n\tvar file;\n\n\tvar match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tfile = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (protectedFiles) {\n\t\t\t\tvar cookie, rawCookies, ref, token, uid;\n\t\t\t\tcookie = new Cookies();\n\n\t\t\t\tif ((typeof req !== 'undefined' && req !== null ? (ref = req.headers) != null ? ref.cookie : void 0 : void 0) != null) {\n\t\t\t\t\trawCookies = req.headers.cookie;\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (uid == null) {\n\t\t\t\t\tuid = req.query.rc_uid;\n\t\t\t\t\ttoken = req.query.rc_token;\n\t\t\t\t}\n\n\t\t\t\tif (!(uid && token && RocketChat.models.Users.findOneByIdAndLoginToken(uid, token))) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","/* globals Slingshot, FileUpload, AWS, SystemLogger */\nvar crypto = Npm.require('crypto');\n\nvar S3accessKey, S3secretKey;\n\nvar generateURL = function(file) {\n\tif (!file || !file.s3) {\n\t\treturn;\n\t}\n\tlet resourceURL = '/' + file.s3.bucket + '/' + file.s3.path + file._id;\n\tlet expires = parseInt(new Date().getTime() / 1000) + 60;\n\tlet StringToSign = 'GET\\n\\n\\n' + expires +'\\n'+resourceURL;\n\tlet signature = crypto.createHmac('sha1', S3secretKey).update(new Buffer(StringToSign, 'utf-8')).digest('base64');\n\treturn file.url + '?AWSAccessKeyId='+encodeURIComponent(S3accessKey)+'&Expires='+expires+'&Signature='+encodeURIComponent(signature);\n};\n\nFileUpload.addHandler('s3', {\n\tget(file, req, res) {\n\t\tlet fileUrl = generateURL(file);\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t},\n\tdelete(file) {\n\t\tlet s3 = new AWS.S3();\n\t\tlet request = s3.deleteObject({\n\t\t\tBucket: file.s3.bucket,\n\t\t\tKey: file.s3.path + file._id\n\t\t});\n\t\trequest.send();\n\t}\n});\n\nvar createS3Directive = _.debounce(() => {\n\tvar directiveName = 'rocketchat-uploads';\n\n\tvar type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tvar bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tvar acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tvar accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tvar secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tvar cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tvar region = RocketChat.settings.get('FileUpload_S3_Region');\n\tvar bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tAWS.config.update({\n\t\taccessKeyId: RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId'),\n\t\tsecretAccessKey: RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey')\n\t});\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives[directiveName]) {\n\t\t\tdelete Slingshot._directives[directiveName];\n\t\t}\n\t\tvar config = {\n\t\t\tbucket: bucket,\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey,\n\t\t\tkey: function (file, metaContext) {\n\t\t\t\tvar path = RocketChat.hostname + '/' + metaContext.rid + '/' + this.userId + '/';\n\n\t\t\t\tlet upload = {\n\t\t\t\t\ts3: {\n\t\t\t\t\t\tbucket: bucket,\n\t\t\t\t\t\tregion: region,\n\t\t\t\t\t\tpath: path\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\tlet fileId = RocketChat.models.Uploads.insertFileInit(metaContext.rid, this.userId, 's3', file, upload);\n\n\t\t\t\treturn path + fileId;\n\t\t\t}\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective(directiveName, Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tSystemLogger.error('Error configuring S3 ->',e.message);\n\t\t}\n\t} else {\n\t\tif (Slingshot._directives[directiveName]) {\n\t\t\tdelete Slingshot._directives[directiveName];\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Bucket', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Acl', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_AWSAccessKeyId', function(key, value) {\n\tS3accessKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey', function(key, value) {\n\tS3secretKey = value;\n\tcreateS3Directive();\n});\n\nRocketChat.settings.get('FileUpload_S3_CDN', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_Region', createS3Directive);\n\nRocketChat.settings.get('FileUpload_S3_BucketURL', createS3Directive);\n","/* globals FileSystemStore:true, FileUpload, UploadFS, RocketChatFile */\n\nlet storeName = 'fileSystem';\n\nFileSystemStore = null;\n\nlet createFileSystemStore = _.debounce(function() {\n\tlet stores = UploadFS.getStores();\n\tif (stores[storeName]) {\n\t\tdelete stores[storeName];\n\t}\n\tFileSystemStore = new UploadFS.store.Local({\n\t\tcollection: RocketChat.models.Uploads.model,\n\t\tname: storeName,\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath'),//'/tmp/uploads/photos',\n\t\tfilter: new UploadFS.Filter({\n\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t}),\n\t\ttransformWrite: function(readStream, writeStream, fileId, file) {\n\t\t\tvar identify, stream;\n\t\t\tif (RocketChatFile.enabled === false || !/^image\\/.+/.test(file.type)) {\n\t\t\t\treturn readStream.pipe(writeStream);\n\t\t\t}\n\t\t\tstream = void 0;\n\t\t\tidentify = function(err, data) {\n\t\t\t\tvar ref;\n\t\t\t\tif (err != null) {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\t\t\t\tfile.identify = {\n\t\t\t\t\tformat: data.format,\n\t\t\t\t\tsize: data.size\n\t\t\t\t};\n\t\t\t\tif ((data.Orientation != null) && ((ref = data.Orientation) !== '' && ref !== 'Unknown' && ref !== 'Undefined')) {\n\t\t\t\t\treturn RocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t\t} else {\n\t\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t\t}\n\t\t\t};\n\t\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t\t\treturn;\n\t\t}\n\t});\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n\nvar fs = Npm.require('fs');\n\nFileUpload.addHandler(storeName, {\n\tget(file, req, res) {\n\t\tlet filePath = FileSystemStore.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tlet stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tres.setHeader('Content-Disposition', 'attachment; filename=\"' + encodeURIComponent(file.name) + '\"');\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tFileSystemStore.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t},\n\tdelete(file) {\n\t\treturn FileSystemStore.delete(file._id);\n\t}\n});\n","/* globals FileUpload, UploadFS */\nvar stream = Npm.require('stream');\nvar zlib = Npm.require('zlib');\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L91\nvar readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tvar store = UploadFS.getStore(storeName);\n\tvar rs = store.getReadStream(fileId, file);\n\tvar ws = new stream.PassThrough();\n\n\trs.on('error', function (err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('error', function (err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t});\n\tws.on('close', function () {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tvar accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/)) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t}\n\t// Compress data using deflate\n\telse if (accept.match(/\\bdeflate\\b/)) {\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t}\n\t// Send raw data\n\telse {\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nFileUpload.addHandler('rocketchat_uploads', {\n\tget(file, req, res) {\n\t\tlet headers = {\n\t\t\t'Content-Disposition': 'attachment; filename=\"' + encodeURIComponent(file.name) + '\"',\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t},\n\tdelete(file) {\n\t\treturn Meteor.fileStore.delete(file._id);\n\t}\n});\n","Meteor.methods({\n\t'sendFileMessage'(roomId, store, file) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error(203, 'User_logged_out');\n\t\t}\n\n\t\tvar room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tvar fileUrl = '/file-upload/' + file._id + '/' + file.name;\n\n\t\tvar attachment = {\n\t\t\ttitle: `File Uploaded: ${file.name}`,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tvar msg = {\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t};\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n});\n"]}