{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_mailer/lib/Mailer.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/startup.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/models/Users.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/functions/sendMail.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/functions/unsubscribe.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/methods/sendMail.coffee","meteor://ðŸ’»app/packages/rocketchat_mailer/server/methods/unsubscribe.coffee"],"names":[],"mappings":"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","file":"/packages/rocketchat_mailer.js","sourcesContent":["Mailer = {}\n","Meteor.startup ->\n\tRocketChat.models.Permissions.upsert( 'access-mailer', { $setOnInsert : { _id: 'access-mailer', roles : ['admin'] } })\n","# Extends model Users\n\nRocketChat.models.Users.RocketMailUnsubscribe = (_id, createdAt) ->\n\n\tquery =\n\t\t_id: _id\n\t\tcreatedAt: new Date(parseInt createdAt)\n\n\tupdate =\n\t\t$set:\n\t\t\t\"mailer.unsubscribed\": true\n\n\taffectedRows = @update query, update\n\n\tconsole.log '[Mailer:Unsubscribe]', _id, createdAt, new Date(parseInt createdAt), affectedRows\n\n\treturn affectedRows\n","Mailer.sendMail = (from, subject, body, dryrun, query) ->\n\n\trfcMailPatternWithName = /^(?:.*<)?([a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)(?:>?)$/\n\t# rfcMailPattern = /^[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/\n\n\tunless rfcMailPatternWithName.test from\n\t\tthrow new Meteor.Error 'invalid-from-address', TAPi18n.__('You_informed_an_invalid_FROM_address')\n\n\tif body.indexOf('[unsubscribe]') is -1\n\t\tthrow new Meteor.Error 'missing-unsubscribe-link', TAPi18n.__('You_must_provide_the_unsubscribe_link')\n\n\tuserQuery = { \"mailer.unsubscribed\": { $exists: 0 } }\n\tif query\n\t\tuserQuery = { $and: [ userQuery, EJSON.parse(query) ] }\n\n\tif dryrun\n\t\tMeteor.users.find({ \"emails.address\": from }).forEach (user) ->\n\t\t# Meteor.users.find({ \"username\": /\\.rocket\\.team/ }).forEach (user) ->\n\t\t\temail = user.emails?[0]?.address\n\n\t\t\thtml = body.replace /\\[unsubscribe\\]/g, Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', { _id: user._id, createdAt: user.createdAt.getTime() }))\n\t\t\thtml = html.replace /\\[name\\]/g, user.name\n\t\t\tfname = _.strLeft user.name, ' '\n\t\t\tlname = _.strRightBack user.name, ' '\n\t\t\thtml = html.replace /\\[fname\\]/g, fname\n\t\t\thtml = html.replace /\\[lname\\]/g, lname\n\t\t\thtml = html.replace /\\[email\\]/g, email\n\t\t\thtml = html.replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2')\n\n\t\t\temail = \"#{user.name} <#{email}>\"\n\n\t\t\tif rfcMailPatternWithName.test email\n\t\t\t\tMeteor.defer ->\n\t\t\t\t\tEmail.send\n\t\t\t\t\t\tto: email\n\t\t\t\t\t\tfrom: from\n\t\t\t\t\t\tsubject: subject\n\t\t\t\t\t\thtml: html\n\n\t\t\t\tconsole.log 'Sending email to ' + email\n\n\telse\n\t\tMeteor.users.find({ \"mailer.unsubscribed\": { $exists: 0 } }).forEach (user) ->\n\t\t# Meteor.users.find({ \"username\": /\\.rocket\\.team/ }).forEach (user) ->\n\t\t\temail = user.emails?[0]?.address\n\n\t\t\thtml = body.replace /\\[unsubscribe\\]/g, Meteor.absoluteUrl(FlowRouter.path('mailer/unsubscribe/:_id/:createdAt', { _id: user._id, createdAt: user.createdAt.getTime() }))\n\t\t\thtml = html.replace /\\[name\\]/g, user.name\n\t\t\tfname = _.strLeft user.name, ' '\n\t\t\tlname = _.strRightBack user.name, ' '\n\t\t\thtml = html.replace /\\[fname\\]/g, fname\n\t\t\thtml = html.replace /\\[lname\\]/g, lname\n\t\t\thtml = html.replace /\\[email\\]/g, email\n\t\t\thtml = html.replace(/([^>\\r\\n]?)(\\r\\n|\\n\\r|\\r|\\n)/g, '$1' + '<br>' + '$2')\n\n\t\t\temail = \"#{user.name} <#{email}>\"\n\n\t\t\tif rfcMailPatternWithName.test email\n\t\t\t\tMeteor.defer ->\n\t\t\t\t\tEmail.send\n\t\t\t\t\t\tto: email\n\t\t\t\t\t\tfrom: from\n\t\t\t\t\t\tsubject: subject\n\t\t\t\t\t\thtml: html\n\n\t\t\t\tconsole.log 'Sending email to ' + email\n","Mailer.unsubscribe = (_id, createdAt) ->\n\tif _id and createdAt\n\t\treturn RocketChat.models.Users.RocketMailUnsubscribe(_id, createdAt) == 1\n\treturn false\n","Meteor.methods\n\t'Mailer.sendMail': (from, subject, body, dryrun, query) ->\n\n\t\treturn Mailer.sendMail from, subject, body, dryrun, query\n\n# Limit setting username once per minute\n# DDPRateLimiter.addRule\n# \ttype: 'method'\n# \tname: 'Mailer.sendMail'\n# \tconnectionId: -> return true\n# , 1, 60000\n","Meteor.methods\n\t'Mailer:unsubscribe': (_id, createdAt) ->\n\t\treturn Mailer.unsubscribe _id, createdAt\n\n# Limit setting username once per minute\nDDPRateLimiter.addRule\n\ttype: 'method'\n\tname: 'Mailer:unsubscribe'\n\tconnectionId: -> return true\n, 1, 60000\n"]}